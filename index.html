<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Generación de Indicaciones Legales con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .indications-output {
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Herramienta de Generación de Indicaciones Legales con IA</h1>
            <p class="text-gray-600 mt-2">Genere indicaciones de modificación comparando un texto original y uno final usando Gemini.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Column 1: Original Text -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Texto Original</h2>
                <textarea id="originalText" class="w-full h-96 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Pegue aquí el texto original aprobado..."></textarea>
            </div>

            <!-- Column 2: Final Text -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Texto Final</h2>
                <textarea id="finalText" class="w-full h-96 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Pegue aquí el texto final modificado..."></textarea>
            </div>

            <!-- Column 3: Generated Indications -->
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Propuesta Indicaciones (Generado por IA)</h2>
                <div id="indicationsResult" class="w-full flex-grow p-3 border border-gray-200 rounded-md bg-gray-50 overflow-y-auto indications-output">
                    Aquí aparecerán sus indicaciones generadas.
                </div>
            </div>
        </div>

        <div class="text-center mt-8">
            <button id="generateButton" onclick="generateIndications()" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Generar Indicaciones
            </button>
        </div>
    </div>

    <script>
        // Pre-fill textareas with example text for demonstration
        document.addEventListener('DOMContentLoaded', (event) => {
            document.getElementById('originalText').value = `Artículo 6.- Costos financieros. El Saldo Final Restante considerará una tasa anual de reajuste que deberá ser aprobada por el Ministerio de Hacienda. Podrá ser fijada en dólares de los Estados Unidos de América, y no podrá exceder la Tasa de Política Monetaria vigente publicada por el Banco Central de Chile, más 25 puntos base. Dicha tasa podrá ser ajustada por el Ministerio de Hacienda, de acuerdo con las condiciones de mercado vigentes al momento de la emisión del documento de pago a que se refiere el artículo 8.`;
            document.getElementById('finalText').value = `Artículo 6.- Costos financieros. El Saldo Final Restante considerará una tasa anual de reajuste que deberá ser aprobada por el Ministerio de Hacienda. Podrá ser fijada en dólares de los Estados Unidos de América, y corresponderá a la Tasa de Política Monetaria vigente publicada por el Banco Central de Chile, más 25 puntos base. Dicha tasa deberá ser ajustada por el Ministerio de Hacienda, de acuerdo con las condiciones de mercado vigentes al momento de la emisión del documento de pago a que se refiere el artículo 8.`;
        });

        /**
         * Calls the Gemini API to generate legal indications based on two text versions.
         */
        async function generateIndications() {
            const originalText = document.getElementById('originalText').value;
            const finalText = document.getElementById('finalText').value;
            const outputDiv = document.getElementById('indicationsResult');
            const generateButton = document.getElementById('generateButton');

            if (!originalText || !finalText) {
                outputDiv.textContent = 'Por favor, ingrese tanto el texto original como el final.';
                return;
            }

            // --- UI: Show loading state ---
            generateButton.disabled = true;
            generateButton.textContent = 'Generando...';
            outputDiv.innerHTML = '<div class="loader"></div>';

            // --- Construct the complex prompt for the Gemini API ---
            const prompt = `
                **Rol y Objetivo:** Eres un asesor legal experto, especializado en la redacción de leyes en Chile. Tu tarea es analizar dos versiones de un texto legal ('Texto Original' y 'Texto Final') y generar una "Propuesta de Indicaciones" formal que describa los cambios con absoluta precisión, utilizando la terminología oficial de la ley chilena.

                **Instrucciones Fundamentales:**
                1.  **Analizar con Precisión:** Compara el 'Texto Original' y el 'Texto Final' para identificar todas las adiciones, eliminaciones y sustituciones.
                2.  **Identificar la Unidad de Cambio Mínima:** Esto es crítico. Antes de concluir que un 'inciso' completo ha sido eliminado o reemplazado, verifica meticulosamente si el cambio es más pequeño. ¿Es solo una 'frase', una 'expresión' o una 'palabra' lo que se ha alterado dentro del inciso? El objetivo es ser lo más específico y minimalista posible en la descripción del cambio.
                3.  **Formular Indicaciones:** Para cada cambio, formula una indicación precisa utilizando el verbo y el sustantivo correctos del glosario a continuación.
                4.  **El Contexto es Clave:** Al describir un cambio, proporciona contexto. Por ejemplo, especifica qué 'inciso' se está modificando.

                **Glosario de Terminología Legislativa (Uso Obligatorio):**

                * **Verbos de Acción:**
                    * **reemplázase / sustitúyese:** Usar cuando se sustituye información. \`sustitúyese\` es para bloques grandes (como un \`inciso\` completo), mientras que \`reemplázase\` es para unidades más pequeñas (\`expresión\`, \`frase\`, \`palabra\`).
                    * **incorpórase / agrégase / añádese:** Usar cuando se añade nueva información.
                    * **suprímese / elimínase:** Usar cuando se elimina información. **Crucialmente, especifica el alcance.** Si solo se elimina una frase de un párrafo, la indicación debe ser 'Suprímese, en el inciso [X], la frase: "[texto a eliminar]"', NO 'Suprímese el inciso [X]'.
                    * **intercálese:** Usar específicamente cuando se añade información *entre* palabras existentes.
                    * **modifícase:** Usar solo para modificaciones genéricas que no encajan en otras categorías (evitar si es posible).

                * **Sustantivos para Unidades de Texto:**
                    * **la expresión:** Un conjunto de palabras. (Uso general).
                    * **la frase:** Un conjunto de palabras con un significado específico.
                    * **la oración:** Una oración completa.
                    * **la palabra / el vocablo:** Una sola palabra.
                    * **el inciso:** Un párrafo o una parte específica de un artículo.

                **Formato de Salida y Ejemplos:**
                La respuesta debe comenzar con una frase introductoria estándar. Cada modificación debe ser un punto separado.

                *Ejemplo de Sustitución:*
                Para modificar el artículo en el siguiente sentido:
                a) Reemplázase, en el inciso primero, la expresión "no podrá exceder" por "corresponderá a".

                *Ejemplo de Eliminación Parcial (Forma Correcta):*
                Para modificar el artículo en el siguiente sentido:
                a) Suprímese, en el inciso segundo, la frase: "sin restricción ni limitación alguna".

                *Ejemplo de Reemplazo de Párrafo Completo:*
                Para modificar el artículo en el siguiente sentido:
                a) Sustitúyese el inciso tercero por el siguiente: "[texto del nuevo párrafo]".

                ---
                **Analiza los siguientes textos:**

                **Texto Original:**
                \`\`\`
                ${originalText}
                \`\`\`

                **Texto Final:**
                \`\`\`
                ${finalText}
                \`\`\`
                ---
                Ahora, genera la "Propuesta de Indicaciones" con la máxima precisión.
            `;

            const apiKey = "AIzaSyCF9HvBvDwEZXw_AJXT_K_qegauLqVajkA"; // This will be handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`La solicitud a la API falló con el estado ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const generatedText = result.candidates[0].content.parts[0].text;
                    outputDiv.innerHTML = generatedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                } else {
                    console.error('Estructura de respuesta de la API inesperada:', result);
                    outputDiv.textContent = 'Error: No se pudo extraer el texto generado de la respuesta de la API. Por favor, revise la consola para más detalles.';
                }

            } catch (error) {
                console.error('Error al llamar a la API de Gemini:', error);
                outputDiv.textContent = `Ocurrió un error al generar las indicaciones. Por favor, inténtelo de nuevo. Detalles: ${error.message}`;
            } finally {
                // --- UI: Restore original state ---
                generateButton.disabled = false;
                generateButton.textContent = 'Generar Indicaciones';
            }
        }
    </script>

</body>
</html>
